###############################################################################
# Dockerfile to build SCRIMMAGE
###############################################################################
FROM ubuntu:22.04 as dependencies

MAINTAINER Kevin DeMarco
ENV DEBIAN_FRONTEND noninteractive
SHELL ["/bin/bash", "-l", "-c"]

# Install initial dependencies and setup .bashrc
RUN apt-get update \
 && apt-get install -y \
    gnupg \
    gnupg2 \
 && apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654 \
 && apt-get update \
 && apt-get install -y \
    cmake \
    software-properties-common \
    python3-pip \
    python3-venv \
    git \
    ninja-build \
    clang \
    build-essential \
    zlib1g-dev \
    libgeographic-dev \
    libeigen3-dev \
    librapidxml-dev \
    libboost-thread-dev \
    libboost-date-time-dev \
    libboost-graph-dev \
    libboost-iostreams-dev \
    libboost-program-options-dev \
    libboost-regex-dev \
    libboost-filesystem-dev \
    libboost-system-dev \
    libboost-chrono-dev \
    libprotobuf-dev \
    protobuf-compiler \
    libgeographic-dev \
    protobuf-compiler-grpc \
    libgrpc++-dev\
    libgrpc-dev \
    libpython3-dev \
    doxygen \
    graphviz \
    python3-sphinx \
    sphinx-rtd-theme-common \
    ccache \
    libbullet-dev \
    libopencv-dev \
    libvtk7-dev \
    wget

# Install a newer version of cppcheck than comes with 22.04
RUN wget https://github.com/danmar/cppcheck/archive/2.14.1.tar.gz \
&& tar -xzf 2.14.1.tar.gz
WORKDIR /cppcheck-2.14.1
RUN  make install MATCHCOMPILER=yes FILESDIR=/usr/share/cppcheck
RUN cppcheck --version


# Install jekyll
WORKDIR /
RUN gpg2 --keyserver hkp://keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB

RUN add-apt-repository -y ppa:rael-gc/rvm \
    && apt-get update \
    && apt-get install -y rvm

RUN groupadd rvm && usermod -a -G rvm root

RUN rvm autolibs packages \
    && rvm install ruby 3.1.0 \
    && gem install fpm

# Build a python virtual environment
WORKDIR /root
COPY ./python/requirements-3.10.txt .
RUN python3 -m venv env \
    && source ./env/bin/activate \
    && pip install wheel \
    && pip install -r requirements-3.10.txt

# Install anything that we need that we don't already have
COPY ./setup .
RUN /root/install-binaries.sh \ 
&& /root/install-jsbsim.sh 

FROM dependencies as builder

# Copy repo code into image
RUN mkdir -p /root/scrimmage/scrimmage
COPY ./ /root/scrimmage/scrimmage

# Test Plugin Generation
WORKDIR /root/scrimmage/scrimmage/scripts
RUN source /root/env/bin/activate \
 && ./create-scrimmage-project.py my-scrimmage-plugins ~/scrimmage \
 && ./generate-plugin.sh autonomy AutonomyTest ~/scrimmage/my-scrimmage-plugins \
 && ./generate-plugin.sh interaction InteractionTest ~/scrimmage/my-scrimmage-plugins \
 && ./generate-plugin.sh metrics MetricsTest ~/scrimmage/my-scrimmage-plugins \
 && ./generate-plugin.sh motion MotionTest ~/scrimmage/my-scrimmage-plugins \
 && ./generate-plugin.sh sensor SensorTest ~/scrimmage/my-scrimmage-plugins \
 && ./generate-plugin.sh controller ControllerTest ~/scrimmage/my-scrimmage-plugins \
 && ./generate-plugin.sh network NetworkTest ~/scrimmage/my-scrimmage-plugins


# Build scrimmage core, plugins, and documentation
WORKDIR /root/scrimmage/scrimmage
RUN source /root/env/bin/activate \
 && mkdir -p build \
 && cd build \
 && source ~/.bashrc \
 && cmake .. -G Ninja \
             -DPYTHON_MIN_VERSION=3.10 \
             -DBUILD_TESTS=ON \
             -DBUILD_DOCS=ON \
             -DCMAKE_CXX_FLAGS="-Werror -Wno-error=deprecated-copy" \
 && source ~/.scrimmage/setup.bash \
 && ninja
 # && ninja docs website-docs


# install python package and run tests
WORKDIR /root/scrimmage/scrimmage/python
RUN source /root/env/bin/activate \
    && python setup.py develop

# run tests
WORKDIR /root/scrimmage/scrimmage/build
RUN source /root/env/bin/activate && \
    source ~/.scrimmage/setup.bash && \
    export SCRIMMAGE_MISSION_PATH=$SCRIMMAGE_MISSION_PATH:$PWD && \
    py.test ../python/scrimmage/openai/tests/test_openai.py && \
    export CTEST_OUTPUT_ON_FAILURE=1 && \
    ninja test && \
    scrimmage ../missions/straight-no-gui.xml && \
    scrimmage ../missions/straight_jsbsim.xml

WORKDIR /root/scrimmage/scrimmage/build
RUN source /root/env/bin/activate && \
    source ~/.scrimmage/setup.bash && \
    export SCRIMMAGE_MISSION_PATH=$SCRIMMAGE_MISSION_PATH:$PWD && \
    py.test ../python/scrimmage/openai/tests/test_openai.py


WORKDIR /root/scrimmage/scrimmage
RUN /bin/bash -c "source /root/env/bin/activate && source ~/.scrimmage/setup.bash && py.test python/tests"

# Run lint and cpp_check tests
WORKDIR /root/scrimmage/scrimmage
RUN source /root/env/bin/activate \
    #&& py.test test/test_cpplint.py \
    && py.test test/test_cppcheck.py

# Setup the scrimmage docker image to run as an executable
ENTRYPOINT ["/root/scrimmage/scrimmage/ci/scripts/scrimmage-wrapper.sh"]
CMD ["/root/scrimmage/scrimmage/missions/straight-no-gui.xml"]



